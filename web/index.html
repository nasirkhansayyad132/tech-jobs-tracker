<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jobs.af Tracker</title>
    <style>
      :root {
        --bg: #f7f1e6;
        --bg-2: #e6f2eb;
        --ink: #1b1b1f;
        --muted: #5f666d;
        --accent: #d97706;
        --accent-2: #0f766e;
        --card: #ffffff;
        --border: #e2ddd0;
        --chip-new: #2563eb;
        --chip-soon: #dc2626;
        --chip-today: #b91c1c;
        --chip-info: #0f766e;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Noto Sans", "Liberation Sans", sans-serif;
        color: var(--ink);
        background: radial-gradient(circle at 20% 20%, #fff7e8 0, transparent 40%),
          radial-gradient(circle at 90% 10%, #e3f1ff 0, transparent 35%),
          linear-gradient(135deg, var(--bg), var(--bg-2));
        min-height: 100vh;
      }

      .wrap {
        max-width: 860px;
        margin: 0 auto;
        padding: 24px 16px 48px;
      }

      .hero {
        display: grid;
        gap: 12px;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 18px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        backdrop-filter: blur(6px);
      }

      .hero h1 {
        margin: 0;
        font-size: 28px;
        letter-spacing: 0.3px;
      }

      .hero p {
        margin: 0;
        color: var(--muted);
      }

      .controls {
        display: grid;
        gap: 12px;
      }

      .run-btn {
        width: 100%;
        border: none;
        background: linear-gradient(135deg, var(--accent), #f59e0b);
        color: #1f1300;
        font-weight: 700;
        padding: 12px 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 10px 18px rgba(217, 119, 6, 0.3);
      }

      .run-btn:disabled {
        opacity: 0.7;
        cursor: default;
        box-shadow: none;
      }

      .run-btn:active {
        transform: translateY(1px);
      }

      .status {
        font-size: 13px;
        color: var(--muted);
      }

      .search-row {
        margin-top: 18px;
        display: grid;
        gap: 12px;
      }

      .search-row input {
        width: 100%;
        padding: 14px 16px;
        border-radius: 14px;
        border: 1px solid var(--border);
        font-size: 16px;
        background: rgba(255, 255, 255, 0.9);
      }

      .meta {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        font-size: 13px;
        color: var(--muted);
      }

      .list {
        margin-top: 20px;
        display: grid;
        gap: 16px;
      }

      .card {
        display: grid;
        gap: 10px;
        padding: 16px;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: var(--card);
        text-decoration: none;
        color: inherit;
        box-shadow: 0 12px 28px rgba(17, 24, 39, 0.08);
        opacity: 0;
        transform: translateY(12px);
        animation: rise 0.6s ease forwards;
      }

      .card h3 {
        margin: 0;
        font-size: 18px;
        line-height: 1.3;
      }

      .company {
        font-size: 14px;
        color: var(--muted);
      }

      .card-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 16px;
        font-size: 13px;
        color: var(--muted);
      }

      .badges {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .badge {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        background: #f3f4f6;
        color: #111827;
        border: 1px solid #e5e7eb;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .badge.new {
        background: rgba(37, 99, 235, 0.15);
        color: #1d4ed8;
        border-color: rgba(37, 99, 235, 0.4);
      }

      .badge.soon {
        background: rgba(220, 38, 38, 0.12);
        color: var(--chip-soon);
        border-color: rgba(220, 38, 38, 0.3);
      }

      .badge.today {
        background: rgba(185, 28, 28, 0.15);
        color: var(--chip-today);
        border-color: rgba(185, 28, 28, 0.35);
      }

      .badge.info {
        background: rgba(15, 118, 110, 0.12);
        color: var(--chip-info);
        border-color: rgba(15, 118, 110, 0.3);
      }

      .empty {
        text-align: center;
        color: var(--muted);
        padding: 28px 18px;
        background: rgba(255, 255, 255, 0.7);
        border: 1px dashed var(--border);
        border-radius: 16px;
      }

      @keyframes rise {
        0% {
          opacity: 0;
          transform: translateY(12px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (min-width: 720px) {
        .hero {
          grid-template-columns: 1.2fr 1fr;
          align-items: center;
        }
        .controls {
          justify-items: end;
        }
        .run-btn {
          width: auto;
        }
      }
    </style>
  </head>
  <body>
    <main class="wrap">
      <header class="hero">
        <div>
          <h1>Jobs.af Tracker</h1>
          <p>Local job feed with alerts for new and expiring roles.</p>
        </div>
        <div class="controls">
          <button id="runBtn" class="run-btn">Run Scrape</button>
          <div id="runStatus" class="status">Idle</div>
        </div>
      </header>

      <section class="search-row">
        <input
          id="searchInput"
          type="search"
          placeholder="Search title, company, or location"
          aria-label="Search jobs"
        />
        <div class="meta">
          <span id="countMeta">0 jobs</span>
          <span id="newMeta">New: 0</span>
          <span id="expMeta">Expiring soon: 0</span>
          <span id="lastRunMeta">Last run: --</span>
        </div>
      </section>

      <section id="jobsList" class="list"></section>
    </main>

    <script>
      const DATA_URL = "/data/jobs_full_open.json";
      const STATE_URL = "/data/last_state.json";

      const runBtn = document.getElementById("runBtn");
      const runStatus = document.getElementById("runStatus");
      const searchInput = document.getElementById("searchInput");
      const listEl = document.getElementById("jobsList");
      const countMeta = document.getElementById("countMeta");
      const newMeta = document.getElementById("newMeta");
      const expMeta = document.getElementById("expMeta");
      const lastRunMeta = document.getElementById("lastRunMeta");

      let allJobs = [];
      let lastState = {};

      const msPerDay = 24 * 60 * 60 * 1000;

      function startOfToday() {
        const d = new Date();
        d.setHours(0, 0, 0, 0);
        return d;
      }

      function parseDate(value) {
        if (!value) return null;
        const d = new Date(value);
        if (Number.isNaN(d.getTime())) return null;
        d.setHours(0, 0, 0, 0);
        return d;
      }

      function daysLeft(job) {
        const dateValue = job.closing_date || job.closing_date_raw;
        const d = parseDate(dateValue);
        if (!d) return null;
        const diff = Math.round((d - startOfToday()) / msPerDay);
        return diff;
      }

      function isNew(job) {
        if (job.is_new) return true;
        const lastNew = lastState.last_new_urls || [];
        return lastNew.includes(job.url);
      }

      function formatApply(method) {
        if (method === "apply_url") return "Apply link";
        if (method === "email") return "Email";
        return "Unknown";
      }

      function formatClosing(job) {
        return job.closing_date || job.closing_date_raw || "Unknown";
      }

      function sortJobs(a, b) {
        const da = parseDate(a.closing_date || a.closing_date_raw);
        const db = parseDate(b.closing_date || b.closing_date_raw);
        if (da && db) return da - db;
        if (da) return -1;
        if (db) return 1;
        return 0;
      }

      function renderList() {
        const query = searchInput.value.trim().toLowerCase();
        let filtered = allJobs;
        if (query) {
          filtered = allJobs.filter((job) => {
            const hay = `${job.title || ""} ${job.company || ""} ${job.location || ""}`
              .toLowerCase()
              .trim();
            return hay.includes(query);
          });
        }
        filtered = filtered.slice().sort(sortJobs);

        listEl.innerHTML = "";
        if (!filtered.length) {
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = query
            ? "No matches. Try a different search."
            : "No job data yet. Run a scrape.";
          listEl.appendChild(empty);
          countMeta.textContent = "0 jobs";
          return;
        }

        filtered.forEach((job, index) => {
          const card = document.createElement("a");
          card.className = "card";
          card.style.animationDelay = `${index * 40}ms`;
          card.href = `job.html?u=${encodeURIComponent(job.url)}`;

          const title = document.createElement("h3");
          title.textContent = job.title || "Untitled";

          const company = document.createElement("div");
          company.className = "company";
          company.textContent = job.company || "Unknown company";

          const meta = document.createElement("div");
          meta.className = "card-meta";
          const loc = document.createElement("span");
          loc.textContent = job.location || "Location unknown";
          const closing = document.createElement("span");
          closing.textContent = `Closing: ${formatClosing(job)}`;
          meta.append(loc, closing);

          const badges = document.createElement("div");
          badges.className = "badges";

          const days = daysLeft(job);
          if (days === 0) {
            const badge = document.createElement("span");
            badge.className = "badge today";
            badge.textContent = "Closing today";
            badges.appendChild(badge);
          } else if (days === 1 || days === 2) {
            const badge = document.createElement("span");
            badge.className = "badge soon";
            badge.textContent = `${days} day${days === 1 ? "" : "s"} left`;
            badges.appendChild(badge);
          } else if (days !== null) {
            const badge = document.createElement("span");
            badge.className = "badge info";
            badge.textContent = `${days} days left`;
            badges.appendChild(badge);
          }

          if (isNew(job)) {
            const badge = document.createElement("span");
            badge.className = "badge new";
            badge.textContent = "New";
            badges.appendChild(badge);
          }

          const apply = document.createElement("div");
          apply.className = "card-meta";
          apply.textContent = `Apply method: ${formatApply(job.apply_method)}`;

          card.append(title, company, meta, badges, apply);
          listEl.appendChild(card);
        });

        countMeta.textContent = `${filtered.length} jobs`;
      }

      async function loadState() {
        try {
          const res = await fetch(STATE_URL, { cache: "no-store" });
          if (!res.ok) return;
          lastState = await res.json();
          lastRunMeta.textContent = `Last run: ${lastState.last_run || "--"}`;
        } catch (err) {
          lastRunMeta.textContent = "Last run: --";
        }
      }

      async function loadJobs() {
        runStatus.textContent = "Loading jobs...";
        try {
          const res = await fetch(DATA_URL, { cache: "no-store" });
          if (!res.ok) throw new Error("Missing data");
          const data = await res.json();
          allJobs = Array.isArray(data) ? data : [];
          updateStats();
          renderList();
          runStatus.textContent = "Ready";
        } catch (err) {
          allJobs = [];
          renderList();
          runStatus.textContent = "No data yet";
        }
      }

      function updateStats() {
        let newCount = 0;
        let expSoon = 0;
        allJobs.forEach((job) => {
          const days = daysLeft(job);
          if (isNew(job)) newCount += 1;
          if (days === 0 || days === 1 || days === 2) expSoon += 1;
        });
        newMeta.textContent = `New: ${newCount}`;
        expMeta.textContent = `Expiring soon: ${expSoon}`;
      }

      async function runScrape() {
        runBtn.disabled = true;
        runStatus.textContent = "Starting scrape...";
        let previousRun = lastState.last_run || "";
        try {
          const res = await fetch("/api/run", { method: "POST" });
          const data = await res.json();
          if (data.status === "busy") {
            runStatus.textContent = "Scrape already running";
            runBtn.disabled = false;
            return;
          }
          if (!data.ok) {
            runStatus.textContent = "Failed to start";
            runBtn.disabled = false;
            return;
          }
          runStatus.textContent = "Scrape running...";
        } catch (err) {
          runStatus.textContent = "Failed to start";
          runBtn.disabled = false;
          return;
        }

        const start = Date.now();
        const poll = async () => {
          if (Date.now() - start > 15 * 60 * 1000) {
            runStatus.textContent = "Still running. Check again.";
            runBtn.disabled = false;
            return;
          }
          await loadState();
          if (lastState.last_run && lastState.last_run !== previousRun) {
            await loadJobs();
            runStatus.textContent = "Updated";
            runBtn.disabled = false;
            return;
          }
          setTimeout(poll, 5000);
        };
        setTimeout(poll, 5000);
      }

      searchInput.addEventListener("input", () => {
        renderList();
      });
      runBtn.addEventListener("click", runScrape);

      (async () => {
        await loadState();
        await loadJobs();
      })();
    </script>
  </body>
</html>
